#!/bin/bash
set -e

ROOT="/root/hyper-factory"
cd "$ROOT" 2>/dev/null || {
  echo "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ $ROOT"
  exit 1
}

echo "ğŸ›  Hyper Factory â€“ Fix structural gaps"
echo "ğŸ“ ROOT = $ROOT"
echo "======================================"

# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯
ensure_dir() {
  local d="$1"
  if [ -d "$d" ]; then
    echo "âœ… DIR Ù…ÙˆØ¬ÙˆØ¯: $d"
  else
    mkdir -p "$d"
    echo "â• ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ DIR: $d"
  fi
}

# Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù„Ù Ù…Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
ensure_file() {
  local f="$1"
  local content="$2"
  if [ -f "$f" ]; then
    echo "âœ… FILE Ù…ÙˆØ¬ÙˆØ¯: $f"
  else
    echo -e "$content" > "$f"
    echo "â• ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ FILE: $f"
  fi
}

echo
echo "1) Data Lakehouse / Catalog"
echo "---------------------------"

ensure_dir "data_lakehouse"
for zone in raw cleansed semantic serving catalog; do
  ensure_dir "data_lakehouse/$zone"
done

# README Ø¨Ø³ÙŠØ· Ù„Ù„Ù€ catalog
ensure_file "data_lakehouse/catalog/README.md" \
"# Data Lakehouse Catalog

This directory stores schemas, table definitions, and metadata
for the Hyper Factory data lakehouse.
"

echo
echo "2) Workers skeleton"
echo "-------------------"

ensure_dir "workers"

for w in ingestor processor analyzer reporter; do
  ensure_dir "workers/$w"
  ensure_file "workers/$w/README.md" \
"# Worker: $w

This directory holds configs, runbooks, and artifacts
for the '$w' worker in the Hyper Factory pipeline.
"
done

echo
echo "3) Advanced Agents â€“ missing engines"
echo "------------------------------------"

ensure_dir "agents"

create_agent_skeleton() {
  local name="$1"
  local nice_name="$2"
  local purpose="$3"

  ensure_dir "agents/$name"

  ensure_file "agents/$name/__init__.py" \
"# $name agent package
# Placeholder for advanced agent: $nice_name
"

  ensure_file "agents/$name/README.md" \
"# Agent: $nice_name

ID: $name

Purpose:
$purpose

Status:
- Skeleton created by hf_fix_gaps.sh
"

  ensure_file "agents/$name/config.yaml" \
"# Config for agent: $name
enabled: false
mode: skeleton
"

  ensure_file "agents/$name/main.py" \
"#!/usr/bin/env python3
\"\"\"Main entrypoint for agent: $name ($nice_name).

This is a skeleton implementation generated by hf_fix_gaps.sh.
\"\"\"

def run():
    print(\"[${name}] skeleton agent â€“ no real logic yet.\")


if __name__ == \"__main__\":
    run()
"
  chmod +x "agents/$name/main.py"
}

# patterns_engine
create_agent_skeleton \
  "patterns_engine" \
  "Patterns Engine" \
  "- Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n- ØªØºØ°ÙŠØ© system_patterns ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©"

# quality_engine
create_agent_skeleton \
  "quality_engine" \
  "Quality Engine" \
  "- ØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø±Ø¬Ø§Øª\n- ÙƒØªØ§Ø¨Ø© Ù…Ø¤Ø´Ø±Ø§Øª ÙÙŠ knowledge_index / system_patterns"

# temporal_memory
create_agent_skeleton \
  "temporal_memory" \
  "Temporal Memory Engine" \
  "- Ø¥Ø¯Ø§Ø±Ø© agent_memory / Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©\n- ØªØªØ¨Ø¹ ØªØ·ÙˆØ± Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØ§Ù„Ø¹Ù…Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø²Ù…Ù†"

# integration_hub
create_agent_skeleton \
  "integration_hub" \
  "Integration Hub" \
  "- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©\n- Ø§Ø³ØªØ®Ø¯Ø§Ù… integrations/* Ù…Ø«Ù„ github_api, notifications"

echo
echo "4) Optional: AI temporal memory folders"
echo "---------------------------------------"

ensure_dir "ai/memory"
ensure_dir "ai/memory/temporal"
ensure_file "ai/memory/temporal/README.md" \
"# Temporal Memory

This folder is reserved for time-based memory snapshots and
agent_memory exports from the knowledge database.
"

echo
echo "5) Re-run advanced audit (if available)"
echo "---------------------------------------"

if [ -x "./advanced_audit.py" ]; then
  echo "ğŸš€ ØªØ´ØºÙŠÙ„ advanced_audit.py Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­..."
  python3 advanced_audit.py || echo "âš ï¸ advanced_audit.py ÙØ´Ù„ØŒ ØªØ­Ù‚Ù‘Ù‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§."
else
  echo "â„¹ï¸ advanced_audit.py ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ° â€“ ØªØ®Ø·Ù‘ÙŠ."
fi

echo
echo "âœ… hf_fix_gaps.sh â€“ Ø§ÙƒØªÙ…Ù„ ØªÙ†ÙÙŠØ° Ø³ÙƒØ±Ø¨Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙØ¬ÙˆØ§Øª."
