from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional
import logging
from pathlib import Path
from datetime import datetime
import os

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====
BASE_DIR = Path("/root/hyper-factory")
KNOWLEDGE_DIR = BASE_DIR / "ai" / "datasets" / "knowledge_chunks"
LOGS_DIR = BASE_DIR / "logs"
ORCHESTRATOR_LOG = LOGS_DIR / "orchestrator" / "decisions.log"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("backend_coach")

app = FastAPI(
    title="ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach",
    description="API Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Backend Junior",
    version="2.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ===== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
class DebugRequest(BaseModel):
    code: str
    error: Optional[str] = None
    language: str = "python"

class DebugResponse(BaseModel):
    success: bool
    analysis: str
    suggestions: List[str]
    fixed_code: str = ""

# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def count_knowledge_chunks() -> int:
    """Ø¹Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ©"""
    try:
        if not KNOWLEDGE_DIR.exists():
            return 0
        return len(list(KNOWLEDGE_DIR.glob("*chunk*")))
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ©: {e}")
        return 0

def get_recent_decisions(limit: int = 10) -> List[str]:
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª"""
    try:
        if not ORCHESTRATOR_LOG.exists():
            return ["âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯"]
        
        with open(ORCHESTRATOR_LOG, 'r', encoding='utf-8') as f:
            lines = f.readlines()
        
        return [line.strip() for line in lines[-limit:]]
    except Exception as e:
        return [f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª: {str(e)}"]

# ===== Endpoints Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====
@app.get("/")
async def root():
    return {
        "message": "ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach API",
        "version": "2.0.0",
        "status": "ÙŠØ¹Ù…Ù„ ğŸš€",
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/health")
async def health():
    return {
        "status": "healthy âœ…",
        "service": "backend_coach",
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/factory/status")
async def factory_status():
    chunks = count_knowledge_chunks()
    return {
        "factory": {
            "name": "Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡",
            "status": "operational ğŸ­",
            "version": "2.0.0",
            "agents_count": 4,
            "knowledge_chunks": chunks,
            "last_updated": datetime.now().isoformat()
        }
    }

@app.get("/api/agents")
async def list_agents():
    agents = [
        {
            "id": "debug_expert",
            "name": "Ø®Ø¨ÙŠØ± ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡",
            "status": "active ğŸŸ¢",
            "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ÙˆØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©"
        },
        {
            "id": "system_architect",
            "name": "Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù†Ø¸Ø§Ù…",
            "status": "active ğŸŸ¢", 
            "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØµÙ…ÙŠÙ… ÙˆÙ‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©"
        },
        {
            "id": "technical_coach",
            "name": "Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„ØªÙ‚Ù†ÙŠ",
            "status": "active ğŸŸ¢",
            "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† ÙˆØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§ØªÙ‡Ù…"
        },
        {
            "id": "knowledge_spider", 
            "name": "Ø¹Ù†ÙƒØ¨ÙˆØª Ø§Ù„Ù…Ø¹Ø±ÙØ©",
            "status": "active ğŸŸ¢",
            "description": "Ù…ØªØ®ØµØµ ÙÙŠ Ø¬Ù…Ø¹ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©"
        }
    ]
    
    return {"agents": agents}

@app.get("/api/knowledge/stats")
async def knowledge_stats():
    chunks = count_knowledge_chunks()
    return {
        "total_chunks": chunks,
        "last_updated": datetime.now().isoformat(),
        "quality": "Ø¬ÙŠØ¯Ø© âœ…" if chunks > 0 else "ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âš ï¸"
    }

@app.get("/api/orchestrator/decisions")
async def orchestrator_decisions(limit: int = Query(10, ge=1, le=100)):
    decisions = get_recent_decisions(limit)
    return {
        "limit": limit,
        "count": len(decisions),
        "items": decisions
    }

@app.post("/api/debug", response_model=DebugResponse)
async def debug_code(request: DebugRequest):
    try:
        logger.info(f"Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ ÙƒÙˆØ¯: {request.language}")
        
        analysis = f"ğŸ” ØªØ­Ù„ÙŠÙ„ ÙƒÙˆØ¯ {request.language}"
        if request.error:
            analysis += f": {request.error}"

        suggestions = [
            "âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨",
            "âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ",
            "âœ… Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø²Ø¡ Ø¬Ø²Ø¡ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø®Ø·Ø£", 
            "âœ… Ø§Ø³ØªØ®Ø¯Ù… print Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØªØ¨Ø¹"
        ]

        return DebugResponse(
            success=True,
            analysis=analysis,
            suggestions=suggestions,
            fixed_code=f"# Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§\n{request.code}"
        )
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­: {e}")
        raise HTTPException(status_code=500, detail="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…")

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=9090, reload=False)

# Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ù‚Ø³Ù… imports
from typing import Dict, Any

# Ø¥Ø¶Ø§ÙØ© endpoint Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
@app.get("/api/orchestrator/analyze")
async def analyze_message(message: str = Query(..., description="Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§"), 
                         user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")):
    """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ LLM"""
    try:
        # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù€ LLM
        import sys
        sys.path.append('/root/hyper-factory/scripts/ai/llm')
        from llm_orchestrator import LLMOrchestrator
        
        orchestrator = LLMOrchestrator()
        analysis = orchestrator.analyze_message(message, user_id)
        
        return {
            "success": True,
            "analysis": analysis,
            "message": message,
            "user_id": user_id,
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ: {e}")
        raise HTTPException(status_code=500, detail="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ")

# Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ù„ÙŠÙ„
class AnalysisResponse(BaseModel):
    success: bool
    analysis: Dict[str, Any]
    message: str
    user_id: str
    timestamp: str

# Ø¥Ø¶Ø§ÙØ© endpoint Ù„ØªØ­Ù…ÙŠÙ„ PDF
from fastapi import UploadFile, File
import shutil

@app.post("/api/knowledge/upload-pdf")
async def upload_pdf(file: UploadFile = File(...)):
    """Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…Ø¹Ø±ÙØ©"""
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
        if not file.filename.lower().endswith('.pdf'):
            raise HTTPException(status_code=400, detail="ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF")
        
        # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…Ø¬Ù„Ø¯ PDFs
        pdf_path = f"/root/hyper-factory/ai/pdfs/{file.filename}"
        with open(pdf_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù
        import subprocess
        result = subprocess.run(
            ["/root/hyper-factory/scripts/ai/pdf_processor/pdf_ingest.sh"],
            capture_output=True, text=True
        )
        
        if result.returncode == 0:
            return {
                "success": True,
                "message": f"ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© PDF Ø¨Ù†Ø¬Ø§Ø­: {file.filename}",
                "filename": file.filename,
                "timestamp": datetime.now().isoformat()
            }
        else:
            raise HTTPException(status_code=500, detail=f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© PDF: {result.stderr}")
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PDF: {e}")
        raise HTTPException(status_code=500, detail=f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: {str(e)}")

@app.get("/api/knowledge/pdf-stats")
async def pdf_stats():
    """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù„ÙØ§Øª PDF"""
    pdf_dir = "/root/hyper-factory/ai/pdfs"
    pdf_chunks_dir = "/root/hyper-factory/ai/datasets/knowledge_chunks"
    
    try:
        pdf_count = len([f for f in os.listdir(pdf_dir) if f.endswith('.pdf')]) if os.path.exists(pdf_dir) else 0
        pdf_chunks_count = len([f for f in os.listdir(pdf_chunks_dir) if 'pdf_chunk' in f]) if os.path.exists(pdf_chunks_dir) else 0
        
        return {
            "pdf_files": pdf_count,
            "pdf_chunks": pdf_chunks_count,
            "last_updated": datetime.now().isoformat()
        }
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF: {e}")
        raise HTTPException(status_code=500, detail="Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª PDF")
