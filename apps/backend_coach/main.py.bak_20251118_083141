from fastapi import FastAPI, HTTPException, Query, UploadFile, File
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List
import logging
from pathlib import Path
from datetime import datetime
import subprocess

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====
BASE_DIR = Path("/root/hyper-factory")
KNOWLEDGE_DIR = BASE_DIR / "ai" / "datasets" / "knowledge_chunks"
LOGS_DIR = BASE_DIR / "logs"
ORCHESTRATOR_LOG = LOGS_DIR / "orchestrator" / "decisions.log"
PDF_DIR = BASE_DIR / "ai" / "pdfs"
PDF_INGEST_SCRIPT = BASE_DIR / "scripts" / "ai" / "pdf_processor" / "pdf_ingest.sh"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("backend_coach")

app = FastAPI(
    title="ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach",
    description="API Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Backend Junior ÙˆØ±Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ©",
    version="2.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ===== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
class DebugRequest(BaseModel):
    code: str
    error: Optional[str] = None
    language: str = "python"


# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def count_knowledge_chunks() -> int:
    if not KNOWLEDGE_DIR.exists():
        return 0
    return len([p for p in KNOWLEDGE_DIR.glob("*") if p.is_file()])


def knowledge_quality(total: int) -> str:
    if total == 0:
        return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø±ÙØ© Ø¨Ø¹Ø¯ âŒ"
    if total < 10:
        return "ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âš ï¸"
    return "Ø¬ÙŠØ¯Ø© âœ…"


def read_decisions(limit: int) -> List[str]:
    if not ORCHESTRATOR_LOG.exists():
        return []
    with ORCHESTRATOR_LOG.open("r", encoding="utf-8", errors="ignore") as f:
        lines = f.readlines()
    return [line.rstrip("\n") for line in lines[-limit:]]


# ===== Endpoints Ø£Ø³Ø§Ø³ÙŠØ© =====
@app.get("/")
def root():
    return {
        "message": "ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach API",
        "version": "2.0.0",
        "status": "ÙŠØ¹Ù…Ù„ ğŸš€",
        "timestamp": datetime.now().isoformat(),
    }


@app.get("/api/health")
def health():
    return {
        "status": "healthy âœ…",
        "service": "backend_coach",
        "timestamp": datetime.now().isoformat(),
    }


@app.get("/api/factory/status")
def factory_status():
    chunks = count_knowledge_chunks()
    return {
        "factory": {
            "name": "Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡",
            "status": "operational ğŸ­",
            "version": "1.0.0",
            "agents_count": 4,
            "knowledge_chunks": chunks,
            "last_updated": datetime.now().isoformat(),
        }
    }


@app.get("/api/knowledge/stats")
def knowledge_stats():
    total = count_knowledge_chunks()
    return {
        "total_chunks": total,
        "last_updated": datetime.now().isoformat(),
        "quality": knowledge_quality(total),
    }


@app.get("/api/orchestrator/decisions")
def orchestrator_decisions(limit: int = Query(10, ge=1, le=100)):
    items = read_decisions(limit)
    return {
        "limit": limit,
        "count": len(items),
        "items": items,
    }


@app.get("/api/agents")
def list_agents():
    chunks = count_knowledge_chunks()
    return {
        "agents": [
            {
                "id": "debug_expert",
                "name": "Ø®Ø¨ÙŠØ± ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ÙˆØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©",
            },
            {
                "id": "system_architect",
                "name": "Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù†Ø¸Ø§Ù…",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØµÙ…ÙŠÙ… ÙˆÙ‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©",
            },
            {
                "id": "technical_coach",
                "name": "Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„ØªÙ‚Ù†ÙŠ",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† ÙˆØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§ØªÙ‡Ù…",
            },
            {
                "id": "knowledge_spider",
                "name": "Ø¹Ù†ÙƒØ¨ÙˆØª Ø§Ù„Ù…Ø¹Ø±ÙØ©",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ Ø¬Ù…Ø¹ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            },
        ],
        "knowledge": {
            "chunks": chunks,
        },
    }


@app.post("/api/debug")
def debug_code(payload: DebugRequest):
    logger.info(f"Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ ÙƒÙˆØ¯: {payload.language}")

    analysis = f"ğŸ” ØªØ­Ù„ÙŠÙ„ ÙƒÙˆØ¯ {payload.language}"
    if payload.error:
        analysis += f": {payload.error}"

    suggestions = [
        "âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨",
        "âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ",
        "âœ… Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø²Ø¡ Ø¬Ø²Ø¡ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø®Ø·Ø£",
        "âœ… Ø§Ø³ØªØ®Ø¯Ù… print Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØªØ¨Ø¹",
    ]

    return {
        "success": True,
        "analysis": analysis,
        "suggestions": suggestions,
        "fixed_code": "# Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§\n" + payload.code,
    }


@app.post("/api/knowledge/upload-pdf")
async def upload_pdf(file: UploadFile = File(...)):
    """Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ PDF Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"""
    if not file.filename.lower().endswith(".pdf"):
        raise HTTPException(status_code=400, detail="ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF")

    PDF_DIR.mkdir(parents=True, exist_ok=True)
    pdf_path = PDF_DIR / file.filename

    try:
        content = await file.read()
        with pdf_path.open("wb") as f:
            f.write(content)
    finally:
        await file.close()

    # ØªØ´ØºÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ PDF Ø¥Ù† ÙˆØ¬Ø¯
    if PDF_INGEST_SCRIPT.exists():
        try:
            subprocess.run([str(PDF_INGEST_SCRIPT)], check=True)
        except Exception as e:
            logger.exception("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ PDF")
            raise HTTPException(
                status_code=500,
                detail=f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù„ÙƒÙ† ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬ PDF: {e}",
            )
    else:
        logger.warning("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙƒØ±Ø¨Øª pdf_ingest.sh")

    total = count_knowledge_chunks()
    return {
        "message": "ØªÙ… Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù (Ø¥Ù† Ø£Ù…ÙƒÙ†)",
        "filename": file.filename,
        "total_chunks": total,
    }


if __name__ == "__main__":
    import uvicorn

    uvicorn.run("main:app", host="0.0.0.0", port=9090, reload=False)
