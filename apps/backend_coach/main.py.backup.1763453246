from fastapi import FastAPI, HTTPException, Query, UploadFile, File
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List
import logging
from pathlib import Path
from datetime import datetime
import subprocess

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====
BASE_DIR = Path("/root/hyper-factory")
KNOWLEDGE_DIR = BASE_DIR / "ai" / "datasets" / "knowledge_chunks"
LOGS_DIR = BASE_DIR / "logs"
ORCHESTRATOR_LOG = LOGS_DIR / "orchestrator" / "decisions.log"
PDF_DIR = BASE_DIR / "ai" / "pdfs"
PDF_INGEST_SCRIPT = BASE_DIR / "scripts" / "ai" / "pdf_processor" / "pdf_ingest.sh"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("backend_coach")

app = FastAPI(
    title="ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach",
    description="API Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Backend Junior ÙˆØ±Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ©",
    version="2.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ===== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
class DebugRequest(BaseModel):
    code: str
    error: Optional[str] = None
    language: str = "python"


# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def count_knowledge_chunks() -> int:
    if not KNOWLEDGE_DIR.exists():
        return 0
    return len([p for p in KNOWLEDGE_DIR.glob("*") if p.is_file()])


def knowledge_quality(total: int) -> str:
    if total == 0:
        return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø±ÙØ© Ø¨Ø¹Ø¯ âŒ"
    if total < 10:
        return "ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âš ï¸"
    return "Ø¬ÙŠØ¯Ø© âœ…"


def read_decisions(limit: int) -> List[str]:
    if not ORCHESTRATOR_LOG.exists():
        return []
    with ORCHESTRATOR_LOG.open("r", encoding="utf-8", errors="ignore") as f:
        lines = f.readlines()
    return [line.rstrip("\n") for line in lines[-limit:]]


# ===== Endpoints Ø£Ø³Ø§Ø³ÙŠØ© =====
@app.get("/")
def root():
    return {
        "message": "ğŸ­ Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ - Backend Coach API",
        "version": "2.0.0",
        "status": "ÙŠØ¹Ù…Ù„ ğŸš€",
        "timestamp": datetime.now().isoformat(),
    }


@app.get("/api/health")
def health():
    return {
        "status": "healthy âœ…",
        "service": "backend_coach",
        "timestamp": datetime.now().isoformat(),
    }


@app.get("/api/factory/status")
def factory_status():
    chunks = count_knowledge_chunks()
    return {
        "factory": {
            "name": "Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡",
            "status": "operational ğŸ­",
            "version": "1.0.0",
            "agents_count": 4,
            "knowledge_chunks": chunks,
            "last_updated": datetime.now().isoformat(),
        }
    }


@app.get("/api/knowledge/stats")
def knowledge_stats():
    total = count_knowledge_chunks()
    return {
        "total_chunks": total,
        "last_updated": datetime.now().isoformat(),
        "quality": knowledge_quality(total),
    }


@app.get("/api/orchestrator/decisions")
def orchestrator_decisions(limit: int = Query(10, ge=1, le=100)):
    items = read_decisions(limit)
    return {
        "limit": limit,
        "count": len(items),
        "items": items,
    }


@app.get("/api/agents")
def list_agents():
    chunks = count_knowledge_chunks()
    return {
        "agents": [
            {
                "id": "debug_expert",
                "name": "Ø®Ø¨ÙŠØ± ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ÙˆØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©",
            },
            {
                "id": "system_architect",
                "name": "Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù†Ø¸Ø§Ù…",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØµÙ…ÙŠÙ… ÙˆÙ‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©",
            },
            {
                "id": "technical_coach",
                "name": "Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„ØªÙ‚Ù†ÙŠ",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙŠÙ† ÙˆØªØ­Ø³ÙŠÙ† Ù…Ù‡Ø§Ø±Ø§ØªÙ‡Ù…",
            },
            {
                "id": "knowledge_spider",
                "name": "Ø¹Ù†ÙƒØ¨ÙˆØª Ø§Ù„Ù…Ø¹Ø±ÙØ©",
                "status": "active ğŸŸ¢",
                "description": "Ù…ØªØ®ØµØµ ÙÙŠ Ø¬Ù…Ø¹ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            },
        ],
        "knowledge": {
            "chunks": chunks,
        },
    }


@app.post("/api/debug")
def debug_code(payload: DebugRequest):
    logger.info(f"Ø·Ù„Ø¨ ØªØµØ­ÙŠØ­ ÙƒÙˆØ¯: {payload.language}")

    analysis = f"ğŸ” ØªØ­Ù„ÙŠÙ„ ÙƒÙˆØ¯ {payload.language}"
    if payload.error:
        analysis += f": {payload.error}"

    suggestions = [
        "âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨",
        "âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ",
        "âœ… Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø²Ø¡ Ø¬Ø²Ø¡ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø®Ø·Ø£",
        "âœ… Ø§Ø³ØªØ®Ø¯Ù… print Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØªØ¨Ø¹",
    ]

    return {
        "success": True,
        "analysis": analysis,
        "suggestions": suggestions,
        "fixed_code": "# Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§\n" + payload.code,
    }


@app.post("/api/knowledge/upload-pdf")
async def upload_pdf(file: UploadFile = File(...)):
    """Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ PDF Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"""
    if not file.filename.lower().endswith(".pdf"):
        raise HTTPException(status_code=400, detail="ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF")

    PDF_DIR.mkdir(parents=True, exist_ok=True)
    pdf_path = PDF_DIR / file.filename

    try:
        content = await file.read()
        with pdf_path.open("wb") as f:
            f.write(content)
    finally:
        await file.close()

    # ØªØ´ØºÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ PDF Ø¥Ù† ÙˆØ¬Ø¯
    if PDF_INGEST_SCRIPT.exists():
        try:
            subprocess.run([str(PDF_INGEST_SCRIPT)], check=True)
        except Exception as e:
            logger.exception("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ PDF")
            raise HTTPException(
                status_code=500,
                detail=f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù„ÙƒÙ† ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬ PDF: {e}",
            )
    else:
        logger.warning("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙƒØ±Ø¨Øª pdf_ingest.sh")

    total = count_knowledge_chunks()
    return {
        "message": "ØªÙ… Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù (Ø¥Ù† Ø£Ù…ÙƒÙ†)",
        "filename": file.filename,
        "total_chunks": total,
    }


if __name__ == "__main__":
    import uvicorn

    uvicorn.run("main:app", host="0.0.0.0", port=9090, reload=False)

# ===== Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LLMOrchestrator =====
@app.get("/api/orchestrator/analyze")
async def analyze_message(
    message: str = Query(..., description="Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
    user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
):
    """
    ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Debug / Architect / Coach / Spider)
    Ù…Ø¹ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.
    """
    try:
        import sys
        sys.path.append("/root/hyper-factory/scripts/ai/llm")
        from llm_orchestrator import LLMOrchestrator
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ LLMOrchestrator: {str(e)}",
        )

    try:
        orchestrator = LLMOrchestrator()
        analysis = orchestrator.analyze_message(message, user_id)
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {str(e)}",
        )

    return {
        "success": True,
        "user_id": user_id,
        "message": message,
        "target_agent": analysis.get("target_agent"),
        "confidence": analysis.get("confidence"),
        "reason": analysis.get("reason"),
    }

# ===== Endpoint Ø¬ÙˆØ§Ø¨ Ø°ÙƒÙŠ Ù…Ø¹ RAG-MVP =====
from fastapi import Query, HTTPException

@app.get("/api/orchestrator/answer")
async def orchestrator_answer(
    message: str = Query(..., description="Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
    user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
):
    """
    Endpoint Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰:
    - ÙŠØ­Ù„Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨.
    - Ù„Ùˆ Ø§Ù„Ø¹Ø§Ù…Ù„ knowledge_spider ÙŠØ³ØªØ®Ø¯Ù… Ø·Ø¨Ù‚Ø© RAG Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø³ÙŠØ§Ù‚Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©.
    - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© MVP Ù„Ø§ ØªØ³ØªØ¯Ø¹ÙŠ LLM ÙØ¹Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¬ÙˆØ§Ø¨ØŒ ÙÙ‚Ø· ØªØ¹ÙŠØ¯ Ø§Ù„Ø³ÙŠØ§Ù‚Ø§Øª.
    """
    try:
        import sys
        sys.path.append("/root/hyper-factory/scripts/ai/llm")
        from llm_orchestrator import LLMOrchestrator
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ LLMOrchestrator: {str(e)}",
        )

    orchestrator = LLMOrchestrator()
    analysis = orchestrator.analyze_message(message, user_id)

    if analysis.get("target_agent") == "knowledge_spider":
        result = orchestrator.answer_with_knowledge(message, user_id)
    else:
        # Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ LLM ÙØ¹Ù„ÙŠ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù€ MVP
        result = {
            "mode": "analysis_only",
            "answer": None,
            "note": "ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙÙ‚Ø·. RAG Ù…Ø®ØµØµ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù€ knowledge_spider.",
        }

    return {
        "success": True,
        "user_id": user_id,
        "message": message,
        "routing": analysis,
        "result": result,
    }

# ===================== Skills System =====================
import os as _os_sk
import sys as _sys_sk
from fastapi import Query, HTTPException

# Ø¶Ù…Ø§Ù† Ù‚Ø¯Ø±Ø© Python Ø¹Ù„Ù‰ Ø±Ø¤ÙŠØ© Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
_ROOT_DIR_SK = _os_sk.path.abspath(_os_sk.path.join(_os_sk.path.dirname(__file__), "..", ".."))
if _ROOT_DIR_SK not in _sys_sk.path:
    _sys_sk.path.append(_ROOT_DIR_SK)

from scripts.ai.skills_manager import SkillsManager  # type: ignore

skills_manager = SkillsManager()


@app.get("/api/skills/state")
async def get_skills_state(
    user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
):
    """
    Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
    - Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    - Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…
    - Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    - Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©
    """
    try:
        profile = skills_manager.get_user_skills(user_id)
        weak_skills = skills_manager.get_weak_skills(user_id)

        return {
            "success": True,
            "user_id": user_id,
            "profile": {
                "track": profile["track_id"],
                "current_phase": profile["current_phase"],
                "overall_progress": profile["overall_progress"],
                "sessions_count": profile["sessions_count"],
                "weak_skills_count": len(weak_skills),
            },
            "weak_skills": weak_skills[:3],
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª: {e}")


@app.post("/api/skills/update")
async def update_skill_score(
    user_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
    skill_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ù…Ù† skills YAML"),
    new_score: int = Query(..., ge=0, le=100, description="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (0-100)"),
):
    """
    ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¬Ø© Ù…Ù‡Ø§Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    """
    try:
        profile = skills_manager.update_skill_score(user_id, skill_id, new_score)

        return {
            "success": True,
            "user_id": user_id,
            "skill_id": skill_id,
            "new_score": new_score,
            "updated_profile": {
                "overall_progress": profile["overall_progress"],
                "current_phase": profile["current_phase"],
            },
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ø±Ø©: {e}")

# ===== ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: Orchestrator + Skills =====
from scripts.ai.llm.llm_orchestrator import LLMOrchestrator
from scripts.ai.skills_manager import SkillsManager
from fastapi import Query, HTTPException

orchestrator = LLMOrchestrator()
skills_manager = SkillsManager()

# Ø®Ø±ÙŠØ·Ø©: Ø£ÙŠ Agent â†’ Ù…Ù‡Ø§Ø±Ø§Øª ÙŠØªÙ… ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ù…Ø¹ ÙƒÙ„ Session
AGENT_SKILL_MAP = {
    "technical_coach": ["python_control_flow", "python_functions_basics"],
    "debug_expert": ["python_errors_handling"],
    "system_architect": ["backend_framework_intro", "db_modeling_basic"],
    "knowledge_spider": ["web_http_fundamentals"],
}


def _auto_update_skills(user_id: str, target_agent: str) -> None:
    """
    ØªØ­Ø¯ÙŠØ« Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù€ agent.

    Ø³ÙŠØ§Ø³Ø© Ø¨Ø³ÙŠØ·Ø©:
    - Ù„Ùˆ score < 40 â†’ +15
    - Ù„Ùˆ 40 <= score < 70 â†’ +10
    - Ù„Ùˆ score >= 70 â†’ +5
    """
    skills_ids = AGENT_SKILL_MAP.get(target_agent, [])
    if not skills_ids:
        return

    profile = skills_manager.get_user_skills(user_id)

    for skill_id in skills_ids:
        current = profile["skills"].get(skill_id, {}).get("score", 0)

        if current < 40:
            delta = 15
        elif current < 70:
            delta = 10
        else:
            delta = 5

        new_score = min(current + delta, 100)
        skills_manager.update_skill_score(
            user_id,
            skill_id,
            new_score,
            practice_context={"source": "auto_session", "agent": target_agent},
        )


@app.post("/api/orchestrator/answer")
async def orchestrator_answer(payload: dict):
    """
    ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©:
    - input: { "message": "...", "user_id": "..." }
    - output: routing + RAG contexts + metadata
    - ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù€ agent
    """
    message = (payload or {}).get("message", "")
    user_id = (payload or {}).get("user_id", "anonymous")

    if not message:
        raise HTTPException(status_code=400, detail="message Ù…Ø·Ù„ÙˆØ¨")

    orchestration = orchestrator.answer_with_rag(message, user_id=user_id)
    target_agent = orchestration.get("routing", {}).get("target_agent")

    if target_agent:
        _auto_update_skills(user_id, target_agent)

    return orchestration


@app.get("/api/skills/state")
async def get_skills_state(
    user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
):
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø£Ù‡Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©
    """
    profile = skills_manager.get_user_skills(user_id)
    weak_skills = skills_manager.get_weak_skills(user_id)

    return {
        "success": True,
        "user_id": user_id,
        "profile": {
            "track": profile["track_id"],
            "current_phase": profile["current_phase"],
            "overall_progress": profile["overall_progress"],
            "sessions_count": profile["sessions_count"],
            "weak_skills_count": len(weak_skills),
        },
        "weak_skills": weak_skills[:3],
    }


@app.post("/api/skills/update")
async def manual_update_skill(
    user_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
    skill_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø© (ÙƒÙ…Ø§ ÙÙŠ YAML)"),
    new_score: int = Query(..., ge=0, le=100, description="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (0-100)"),
):
    """
    ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù„Ø¯Ø±Ø¬Ø© Ù…Ù‡Ø§Ø±Ø© Ù…Ø¹ÙŠÙ†Ø© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø£Ùˆ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ©)
    """
    profile = skills_manager.update_skill_score(
        user_id,
        skill_id,
        new_score,
        practice_context={"source": "manual_update"},
    )

    return {
        "success": True,
        "user_id": user_id,
        "skill_id": skill_id,
        "new_score": new_score,
        "overall_progress": profile["overall_progress"],
        "current_phase": profile["current_phase"],
    }

# ===== Orchestrator + Skills Integration =====
import os as _os_int
import sys as _sys_int
from fastapi import Query, HTTPException

# Ø¶Ù…Ø§Ù† Ø±Ø¤ÙŠØ© Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ sys.path
_ROOT_DIR_INT = _os_int.path.abspath(_os_int.path.join(_os_int.path.dirname(__file__), "..", ".."))
if _ROOT_DIR_INT not in _sys_int.path:
    _sys_int.path.append(_ROOT_DIR_INT)

from scripts.ai.llm.llm_orchestrator import LLMOrchestrator
from scripts.ai.skills_manager import SkillsManager

orchestrator = LLMOrchestrator()
skills_manager = SkillsManager()

# Ø®Ø±ÙŠØ·Ø©: Ø£ÙŠ Agent â†’ Ù…Ù‡Ø§Ø±Ø§Øª ÙŠØªÙ… ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ù…Ø¹ ÙƒÙ„ Session
AGENT_SKILL_MAP = {
    "technical_coach": ["python_control_flow", "python_functions_basics"],
    "debug_expert": ["python_errors_handling"],
    "system_architect": ["backend_framework_intro", "db_modeling_basic"],
    "knowledge_spider": ["web_http_fundamentals"],
}


def _auto_update_skills(user_id: str, target_agent: str) -> None:
    """
    ØªØ­Ø¯ÙŠØ« Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù€ agent.

    Ø³ÙŠØ§Ø³Ø© Ø¨Ø³ÙŠØ·Ø©:
    - Ù„Ùˆ score < 40 â†’ +15
    - Ù„Ùˆ 40 <= score < 70 â†’ +10
    - Ù„Ùˆ score >= 70 â†’ +5
    """
    skills_ids = AGENT_SKILL_MAP.get(target_agent, [])
    if not skills_ids:
        return

    profile = skills_manager.get_user_skills(user_id)

    for skill_id in skills_ids:
        current = profile["skills"].get(skill_id, {}).get("score", 0)

        if current < 40:
            delta = 15
        elif current < 70:
            delta = 10
        else:
            delta = 5

        new_score = min(current + delta, 100)
        skills_manager.update_skill_score(
            user_id,
            skill_id,
            new_score,
            practice_context={"source": "auto_session", "agent": target_agent},
        )


@app.post("/api/orchestrator/answer")
async def orchestrator_answer(payload: dict):
    """
    ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©:
    - input: { "message": "...", "user_id": "..." }
    - output: routing + RAG contexts + metadata
    - ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù€ agent
    """
    message = (payload or {}).get("message", "")
    user_id = (payload or {}).get("user_id", "anonymous")

    if not message:
        raise HTTPException(status_code=400, detail="message Ù…Ø·Ù„ÙˆØ¨")

    orchestration = orchestrator.answer_with_rag(message, user_id=user_id)
    target_agent = orchestration.get("routing", {}).get("target_agent")

    if target_agent:
        _auto_update_skills(user_id, target_agent)

    return orchestration


@app.get("/api/skills/state")
async def get_skills_state(
    user_id: str = Query("anonymous", description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
):
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø£Ù‡Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©
    """
    profile = skills_manager.get_user_skills(user_id)
    weak_skills = skills_manager.get_weak_skills(user_id)

    return {
        "success": True,
        "user_id": user_id,
        "profile": {
            "track": profile["track_id"],
            "current_phase": profile["current_phase"],
            "overall_progress": profile["overall_progress"],
            "sessions_count": profile["sessions_count"],
            "weak_skills_count": len(weak_skills),
        },
        "weak_skills": weak_skills[:3],
    }


@app.post("/api/skills/update")
async def manual_update_skill(
    user_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"),
    skill_id: str = Query(..., description="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø© (ÙƒÙ…Ø§ ÙÙŠ YAML)"),
    new_score: int = Query(..., ge=0, le=100, description="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (0-100)"),
):
    """
    ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù„Ø¯Ø±Ø¬Ø© Ù…Ù‡Ø§Ø±Ø© Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    """
    profile = skills_manager.update_skill_score(
        user_id,
        skill_id,
        new_score,
        practice_context={"source": "manual_update"},
    )

    return {
        "success": True,
        "user_id": user_id,
        "skill_id": skill_id,
        "new_score": new_score,
        "overall_progress": profile["overall_progress"],
        "current_phase": profile["current_phase"],
    }

# Auto-wired skills & orchestrator router
from skills_api import router as skills_router  # noqa: E402
app.include_router(skills_router, prefix="/api")
