#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
hf_manager_dashboard.py

Manager Dashboard:
- ÙŠÙ‚Ø±Ø£ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
  1) Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù€ pipeline:
     - data/report/summary_basic.json   (Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª) 
  2) Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø©:
     - ai/memory/lessons/*.json         (Actions)
  3) Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬ ÙˆØ§Ù„Ù€ Phases:
     - ai/memory/curriculum/roadmap.json
  4) Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆØ±ÙˆØ§ØªØ¨ Ø§Ù„Ù€ Agents:
     - ai/memory/people/agents_levels.json

- ÙŠÙ†ØªØ¬ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµÙ†Ø¹:
  - reports/management/{timestamp}_manager_daily_overview.txt
  - reports/management/{timestamp}_manager_daily_overview.json

Ù„Ø§ ÙŠÙ‚ÙˆÙ… Ø¨Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ config/ Ø£Ùˆ Ø£ÙŠ Ù…Ù„Ù ØªØ´ØºÙŠÙ„.
"""

import json
from pathlib import Path
from datetime import datetime
import glob

ROOT = Path(__file__).resolve().parent.parent

SUMMARY_BASIC_PATH = ROOT / "data" / "report" / "summary_basic.json"
LESSONS_DIR = ROOT / "ai" / "memory" / "lessons"
ROADMAP_PATH = ROOT / "ai" / "memory" / "curriculum" / "roadmap.json"
AGENTS_LEVELS_PATH = ROOT / "ai" / "memory" / "people" / "agents_levels.json"
MANAGEMENT_DIR = ROOT / "reports" / "management"


def load_json(path, default=None):
    if default is None:
        default = {}
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù: {path}")
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© JSON Ù…Ù† {path}: {e}")
    return default


def load_kpis():
    data = load_json(SUMMARY_BASIC_PATH, {})
    total_runs = int(data.get("total_runs") or 0)
    success_runs = int(data.get("success_runs") or 0)
    failed_runs = int(data.get("failed_runs") or 0)

    if total_runs > 0:
        avg_success_rate = success_runs / total_runs
    else:
        avg_success_rate = None

    # Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø³ØªÙ‚Ø±Ø§Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠØ©
    if avg_success_rate is None:
        status_note = "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± (Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©)"
    else:
        if avg_success_rate >= 0.98:
            status_note = "Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¹Ø§Ù„Ù"
        elif avg_success_rate >= 0.90:
            status_note = "Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù…ØªÙˆØ³Ø· â€“ ÙŠÙØ¶Ù‘Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¶Ø§ÙÙŠØ©"
        else:
            status_note = "Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù…Ù†Ø®ÙØ¶ â€“ ÙŠÙØ¶Ù‘Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù„ÙˆØ¬Ø§Øª"

    return {
        "total_runs": total_runs,
        "success_runs": success_runs,
        "failed_runs": failed_runs,
        "avg_success_rate": avg_success_rate,
        "status_note": status_note,
    }



def load_lessons(max_items=10):
    """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³ Ù…Ù† ai/memory/lessons/"""
    lessons_dir = ROOT / "ai" / "memory" / "lessons"
    lessons = []
    
    if lessons_dir.exists():
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª JSON
        lesson_files = list(lessons_dir.glob("*.json"))
        print(f"ğŸ” Ø§ÙƒØªØ´Ø§Ù {len(lesson_files)} Ù…Ù„Ù Ø¯Ø±Ø³ ÙÙŠ {lessons_dir}")
        
        for lesson_file in lesson_files[:max_items]:
            try:
                with open(lesson_file, 'r', encoding='utf-8') as f:
                    lesson_data = json.load(f)
                    lesson_info = {
                        'file': lesson_file.name,
                        'title': lesson_data.get('title', lesson_data.get('lesson_title', 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')),
                        'description': lesson_data.get('description', lesson_data.get('lesson_description', '')),
                        'priority': lesson_data.get('priority', 'medium')
                    }
                    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
                    if lesson_info['title'] != 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†':
                        lessons.append(lesson_info)
                    else:
                        print(f"âš ï¸ Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù† ØµØ§Ù„Ø­: {lesson_file.name}")
            except Exception as e:
                print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ {lesson_file}: {e}")
    
    return lessons


    for path_str in sorted(glob.glob(str(LESSONS_DIR / "*.json"))):
        path = Path(path_str)
        raw = load_json(path, {})
        items = []
        if isinstance(raw, list):
            items = raw
        elif isinstance(raw, dict):
            if "lessons" in raw and isinstance(raw["lessons"], list):
                items = raw["lessons"]

        for item in items:
            lesson_id = item.get("id") or item.get("key") or "unknown"
            title = item.get("title") or "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"
            priority = item.get("priority") or "MEDIUM"
            date = item.get("date") or "N/A"
            desc = item.get("description") or item.get("desc") or ""
            if isinstance(desc, list):
                desc_text = " ".join(str(x) for x in desc)
            else:
                desc_text = str(desc)
            lessons.append(
                {
                    "id": lesson_id,
                    "title": title,
                    "priority": priority,
                    "date": date,
                    "source_file": path.name,
                    "description": desc_text,
                }
            )

    # ØªØ±ØªÙŠØ¨ Ø¨Ø³ÙŠØ·: Ø­Ø³Ø¨ priority Ø«Ù… date (Ø¥Ù† ÙˆØ¬Ø¯)
    def priority_rank(p):
        p = str(p).upper()
        if p == "HIGH":
            return 0
        if p == "MEDIUM":
            return 1
        if p == "LOW":
            return 2
        return 3

    lessons.sort(key=lambda x: (priority_rank(x["priority"]), x["date"]))
    return lessons[:max_items]


def load_curriculum():
    data = load_json(ROADMAP_PATH, {})
    phases = []

    raw_phases = []
    if isinstance(data, dict):
        if isinstance(data.get("phases"), list):
            raw_phases = data["phases"]
        elif isinstance(data.get("curriculum_phases"), list):
            raw_phases = data["curriculum_phases"]
    elif isinstance(data, list):
        raw_phases = data

    current_phase = None
    for ph in raw_phases:
        pid = ph.get("id") or ph.get("key") or "phase"
        title = ph.get("title") or "Ù…Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"
        desc = ph.get("description") or ph.get("desc") or ""
        status = ph.get("status") or ph.get("state") or ""
        phase = {
            "id": pid,
            "title": title,
            "description": desc,
            "status": status,
        }
        phases.append(phase)
        if (str(status).lower() in ("current", "active")) and current_phase is None:
            current_phase = phase

    return phases, current_phase


def load_agents_levels():
    data = load_json(AGENTS_LEVELS_PATH, [])
    agents = []
    if isinstance(data, list):
        for item in data:
            agent_name = item.get("agent", "unknown")
            family = item.get("family", "pipeline")
            display_name = item.get("display_name") or agent_name
            level = item.get("level") or "unknown"
            salary_index = item.get("salary_index")
            success_rate = item.get("success_rate")

            agents.append(
                {
                    "agent": agent_name,
                    "display_name": display_name,
                    "family": family,
                    "level": level,
                    "salary_index": salary_index,
                    "success_rate": success_rate,
                }
            )
    else:
        print(f"â„¹ï¸ Ø´ÙƒÙ„ agents_levels.json ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {AGENTS_LEVELS_PATH}")
    return agents


def build_text_report(kpis, lessons, phases, current_phase, agents):
    lines = []
    ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    lines.append("===== Hyper Factory â€“ Manager Daily Overview =====")
    lines.append(f"Generated at : {ts} UTC")
    lines.append("")

    # 1) KPIs
    lines.append("== 1) Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ø¹Ø§Ù…Ø© (KPIs) ==")
    lines.append(f"- Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø©        : N/A")
    lines.append(f"- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª        : {kpis['total_runs']}")
    lines.append(f"- Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©        : {kpis['success_runs']}")
    lines.append(f"- Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©        : {kpis['failed_runs']}")
    if kpis["avg_success_rate"] is not None:
        lines.append(f"- Ù…ØªÙˆØ³Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­          : {kpis['avg_success_rate']*100:.2f}%")
    else:
        lines.append(f"- Ù…ØªÙˆØ³Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­          : N/A")
    lines.append(f"- Ù…Ù„Ø§Ø­Ø¸Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±      : {kpis['status_note']}")
    lines.append("")

    # 2) Lessons
    lines.append("== 2) Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø© (Top Lessons Snapshot) ==")
    if not lessons:
        lines.append("- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…Ø³Ø¬Ù‘Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (ai/memory/lessons/*.json).")
    else:
        for idx, l in enumerate(lessons, start=1):
            lines.append(
                f"[{idx}] id={l['id']} | priority={l['priority']} | date={l['date']}"
            )
            lines.append(f"    title: {l['title']}")
            lines.append(f"    desc : {l['description']}")
    lines.append("")

    # 3) Agents Levels
    lines.append("== 3) Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¢Ù„ÙŠÙŠÙ† (Agents Levels & Compensation) ==")
    if not agents:
        lines.append("- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙˆÙŠØ§Øª Agents (ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† hf_roles_engine).")
    else:
        for a in agents:
            sr = a["success_rate"]
            sr_txt = f"{sr*100:.2f}%" if isinstance(sr, (int, float)) else "N/A"
            lines.append(
                f"- {a['display_name']} [{a['agent']} / {a['family']}] "
                f": Ø§Ù„Ù†Ø¬Ø§Ø­={sr_txt}, Ø§Ù„Ù…Ø³ØªÙˆÙ‰={a['level']}, Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø§ØªØ¨={a['salary_index']}"
            )
    lines.append("")

    # 4) Curriculum
    lines.append("== 4) Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬ ÙˆØ§Ù„ØªØ·ÙˆÙ‘Ø± (Curriculum Phases) ==")
    if current_phase is not None:
        lines.append(f"- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© : {current_phase['title']}")
    else:
        lines.append("- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø­Ù„Ø© Ù…Ø¹Ù„Ù‘Ù…Ø© ÙƒÙ€ current/active Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.")

    if phases:
        lines.append("- Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©:")
        for ph in phases:
            lines.append(
                f"  * {ph['title']} (id={ph['id']}, status={ph['status']})"
            )
            if ph["description"]:
                lines.append(f"    â€¢ {ph['description']}")
    else:
        lines.append("- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ù…Ø³Ø¬Ù‘Ù„Ø© ÙÙŠ roadmap.json.")
    lines.append("")

    # 5) Action List
    lines.append("== 5) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµÙ†Ø¹ (Action List) ==")
    lines.append("- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¢Ø®Ø± Ù…Ù„ÙØ§Øª config_changes (agents.diff / factory.diff) ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.")
    if agents:
        agent_names = ", ".join(a["agent"] for a in agents)
        lines.append(f"- ØªØµÙ…ÙŠÙ… Ø®Ø·Ø© ØªØ·ÙˆÙŠØ±/ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù€ Agents Ø§Ù„ØªØ§Ù„ÙŠØ©: {agent_names}.")
    else:
        lines.append("- Ù„Ø§ ØªÙˆØ¬Ø¯ Agents Ù…Ø³Ø¬Ù‘Ù„Ø© Ø¨Ø¹Ø¯Ø› Ø´ØºÙ‘Ù„ hf_roles_engine Ø£ÙˆÙ„Ø§Ù‹.")
    lines.append("- Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ ØªØ´ØºÙŠÙ„ run_basic_with_memory.sh Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ù„Ø¶Ù…Ø§Ù† ØªØ±Ø§ÙƒÙ… Ø§Ù„Ø°Ø§ÙƒØ±Ø© (messages/lessons/metrics).")

    return "\n".join(lines)


def build_json_report(kpis, lessons, phases, current_phase, agents):
    ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    return {
        "generated_at": ts,
        "kpis": kpis,
        "lessons": lessons,
        "curriculum": {
            "current_phase": current_phase,
            "phases": phases,
        },
        "agents_levels": agents,
        "actions": [
            "Ù…Ø±Ø§Ø¬Ø¹Ø© config_changes (agents.diff / factory.diff).",
            "ØªØ´ØºÙŠÙ„ run_basic_with_memory.sh Ø¨Ø§Ù†ØªØ¸Ø§Ù….",
        ],
        "hint": "Ù‡Ø°Ø§ Ù…Ù„Ù Ù…Ù„Ø®Ù‘Øµ ØªÙ†ÙÙŠØ°ÙŠ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡ØªÙ‡ Ù…Ù† Ø£ÙŠ Dashboard Ø£Ùˆ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.",
    }


def main():
    print("ğŸ“ ROOT        :", ROOT)
    MANAGEMENT_DIR.mkdir(parents=True, exist_ok=True)

    kpis = load_kpis()
    lessons = load_lessons(max_items=5)
    phases, current_phase = load_curriculum()
    agents = load_agents_levels()

    text_report = build_text_report(kpis, lessons, phases, current_phase, agents)
    json_report = build_json_report(kpis, lessons, phases, current_phase, agents)

    ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    txt_path = MANAGEMENT_DIR / f"{ts}_manager_daily_overview.txt"
    json_path = MANAGEMENT_DIR / f"{ts}_manager_daily_overview.json"

    try:
        with open(txt_path, "w", encoding="utf-8") as f:
            f.write(text_report + "\n")
        print(f"âœ… ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ± (TXT): {txt_path}")
    except Exception as e:
        print(f"âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ TXT Ø§Ù„Ø®Ø§Øµ Ø¨ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: {e}")

    try:
        with open(json_path, "w", encoding="utf-8") as f:
            json.dump(json_report, f, ensure_ascii=False, indent=2)
        print(f"âœ… ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ± (JSON): {json_path}")
    except Exception as e:
        print(f"âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ JSON Ø§Ù„Ø®Ø§Øµ Ø¨ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: {e}")

    print("----------------------------------------")
    print("ğŸ“„ Ø£Ø­Ø¯Ø« ØªÙ‚Ø±ÙŠØ± Manager Dashboard:")
    print(f"   {txt_path.relative_to(ROOT)}")


if __name__ == "__main__":
    main()
