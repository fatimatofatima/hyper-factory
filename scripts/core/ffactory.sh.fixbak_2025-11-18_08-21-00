#!/bin/bash
# ffactory.sh - ุงูุณูุฑูุจุช ุงูุฑุฆูุณู ูููุตูุน (ุงููุณุฎุฉ ุงููุญุณูุฉ)

set -e

# ุงููุณุงุฑ ุงูุซุงุจุช ุจุฏู $HOME ููุชุฃูุฏ ูู ุงูุฏูุฉ
BASE_DIR="/root/hyper-factory"
SCRIPTS_DIR="$BASE_DIR/scripts/core"
AI_SCRIPTS_DIR="$BASE_DIR/scripts/ai"
LOGS_DIR="$BASE_DIR/logs"

# ุงูุฃููุงู ูููุงุฌูุฉ ุงูุฌูููุฉ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ุฏุงูุฉ ููุทุจุงุนุฉ ุงูููููุฉ
log_info() { echo -e "${BLUE}โน๏ธ  $1${NC}"; }
log_success() { echo -e "${GREEN}โ $1${NC}"; }
log_warning() { echo -e "${YELLOW}โ๏ธ  $1${NC}"; }
log_error() { echo -e "${RED}โ $1${NC}"; }
log_debug() { echo -e "${CYAN}๐ $1${NC}"; }

# ุงูุชุญูู ูู ูุฌูุฏ ุงููุตูุน
check_factory_exists() {
    if [ ! -d "$BASE_DIR" ]; then
        log_error "ุงููุตูุน ุบูุฑ ููุฌูุฏ ูู: $BASE_DIR"
        exit 1
    fi
}

# ุนุฑุถ ุงูุงุณุชุฎุฏุงู
usage() {
    echo -e "${CYAN}๐ญ ูุตูุน ุงูุนูุงู ุงูุฃุฐููุงุก - ูุญุฏุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ${NC}"
    echo ""
    echo -e "${BLUE}ุงูุงุณุชุฎุฏุงู:${NC}"
    echo "  $0 init                              # ุชููุฆุฉ ุงููุตูุน"
    echo "  $0 start <app_id>                   # ุชุดุบูู ุชุทุจูู"
    echo "  $0 stop <app_id>                    # ุฅููุงู ุชุทุจูู"
    echo "  $0 decide \"ุฑุณุงูุฉ\" [user_id]       # ุงุณุชุดุงุฑุฉ ุงููุฏูุฑ"
    echo "  $0 spider [--seeds ููู] [--test]    # ุชุดุบูู ุงูุนููุจูุช"
    echo "  $0 status [--detailed]              # ุญุงูุฉ ุงููุตูุน"
    echo "  $0 logs [type] [--follow]           # ุนุฑุถ ุงูุณุฌูุงุช"
    echo "  $0 agents                           # ูุงุฆูุฉ ุงูุนูุงู"
    echo "  $0 knowledge                        # ุฅุญุตุงุฆูุงุช ุงููุนุฑูุฉ"
    echo "  $0 clean [--days ุนุฏุฏ]               # ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ"
    echo ""
    echo -e "${YELLOW}ุฃูุซูุฉ:${NC}"
    echo "  $0 decide \"ุนูุฏู ุฎุทุฃ ูู ุงูููุฏ\" user_123"
    echo "  $0 spider --seeds custom_urls.txt --test"
    echo "  $0 status --detailed"
    echo "  $0 logs orchestrator --follow"
    echo "  $0 clean --days 7"
}

# ุชููุฆุฉ ุงููุตูุน
init_factory() {
    log_info "ุจุฏุก ุชููุฆุฉ ุงููุตูุน..."
    "$SCRIPTS_DIR/init_factory.sh"
}

# ุชุดุบูู ุงูุชุทุจููุงุช
start_app() {
    local app_id="$1"
    if [ -z "$app_id" ]; then
        log_error "ูุฌุจ ุชุญุฏูุฏ ูุนุฑู ุงูุชุทุจูู"
        echo -e "${YELLOW}ุงูุชุทุจููุงุช ุงููุชุงุญุฉ:${NC}"
        find "$BASE_DIR/apps" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | while read app; do
            echo "  - $app"
        done
        exit 1
    fi
    
    log_info "ุชุดุบูู ุงูุชุทุจูู: $app_id"
    "$SCRIPTS_DIR/start_app.sh" "$app_id"
}

# ุฅููุงู ุงูุชุทุจููุงุช
stop_app() {
    local app_id="$1"
    if [ -z "$app_id" ]; then
        log_error "ูุฌุจ ุชุญุฏูุฏ ูุนุฑู ุงูุชุทุจูู"
        exit 1
    fi
    
    log_info "ุฅููุงู ุงูุชุทุจูู: $app_id"
    
    # ุงูุจุญุซ ุนู PID ูุฅููุงูู
    local pid_file="$LOGS_DIR/apps/$app_id.pid"
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
            log_success "ุชู ุฅููุงู ุงูุชุทุจูู $app_id (PID: $pid)"
            rm -f "$pid_file"
        else
            log_warning "ุงูุชุทุจูู $app_id ุบูุฑ ุดุบุงู"
            rm -f "$pid_file"
        fi
    else
        log_error "ูู ูุชู ุงูุนุซูุฑ ุนูู ููู PID ููุชุทุจูู $app_id"
    fi
}

# ุงุณุชุดุงุฑุฉ ุงููุฏูุฑ
decide_agent() {
    local message="$1"
    local user_id="${2:-anonymous}"
    
    if [ -z "$message" ]; then
        log_error "ูุฌุจ ุชูุฏูู ุฑุณุงูุฉ"
        usage
        exit 1
    fi
    
    log_info "ุงุณุชุดุงุฑุฉ ุงููุฏูุฑ (ุงููุณุชุฎุฏู: $user_id)"
    log_debug "ุงูุฑุณุงูุฉ: $message"
    
    "$SCRIPTS_DIR/orchestrator_decision_engine.sh" decide "$message" "$user_id"
}

# ุชุดุบูู ุงูุนููุจูุช
run_spider() {
    local seeds_file=""
    local test_mode=false
    
    # ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช
    while [[ $# -gt 0 ]]; do
        case $1 in
            --seeds)
                seeds_file="$2"
                shift 2
                ;;
            --test)
                test_mode=true
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    log_info "ุชุดุบูู ุนููุจูุช ุงููุนุฑูุฉ..."
    
    if [ -n "$seeds_file" ]; then
        if [ -f "$seeds_file" ]; then
            log_info "ุงุณุชุฎุฏุงู ููู ุงูุจุฐูุฑ ุงููุฎุตุต: $seeds_file"
            cp "$seeds_file" "$BASE_DIR/ai/datasets/spider_seeds/urls.txt"
        else
            log_error "ููู ุงูุจุฐูุฑ ุบูุฑ ููุฌูุฏ: $seeds_file"
            exit 1
        fi
    fi
    
    if [ "$test_mode" = true ]; then
        log_info "ูุถุน ุงูุงุฎุชุจุงุฑ ููุนู - ุณูุชู ุฌูุน ุนุฏุฏ ูุญุฏูุฏ ูู ุงูุตูุญุงุช"
        # ูููู ุฅุถุงูุฉ ูุชุบูุฑ ุจูุฆุฉ ูููุถุน ุงูุงุฎุชุจุงุฑู
        TEST_MODE=true "$AI_SCRIPTS_DIR/knowledge_spider.sh"
    else
        "$AI_SCRIPTS_DIR/knowledge_spider.sh"
    fi
}

# ุญุงูุฉ ุงููุตูุน
show_status() {
    local detailed=false
    
    # ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช
    while [[ $# -gt 0 ]]; do
        case $1 in
            --detailed)
                detailed=true
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    echo -e "${CYAN}๐ ุญุงูุฉ ูุตูุน ุงูุนูุงู ุงูุฃุฐููุงุก${NC}"
    echo "=========================================="
    
    # ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ
    echo -e "${BLUE}๐๏ธ  ุงููููู:${NC}"
    echo "  - ุงููุณุงุฑ: $BASE_DIR"
    
    # ุงูุชุทุจููุงุช (ุจุฏูุฉ ุฃูุจุฑ)
    local app_count=$(find "$BASE_DIR/apps" -mindepth 1 -maxdepth 1 -type d | wc -l)
    echo -e "${BLUE}๐ฆ ุงูุชุทุจููุงุช:${NC}"
    echo "  - ุงูุนุฏุฏ: $app_count"
    
    # ุงูุชุทุจููุงุช ุงููุดุทุฉ
    local active_apps=0
    for app_dir in "$BASE_DIR/apps"/*/; do
        if [ -d "$app_dir" ]; then
            local app_name=$(basename "$app_dir")
            local pid_file="$LOGS_DIR/apps/${app_name}.pid"
            if [ -f "$pid_file" ] && kill -0 $(cat "$pid_file") 2>/dev/null; then
                ((active_apps++))
                if [ "$detailed" = true ]; then
                    echo "    โ $app_name (ูุดุท)"
                fi
            elif [ "$detailed" = true ]; then
                echo "    โ $app_name (ูุชููู)"
            fi
        fi
    done
    echo "  - ุงููุดุทุฉ: $active_apps"
    
    # ุงููุนุฑูุฉ
    local knowledge_chunks=$(find "$BASE_DIR/ai/datasets/knowledge_chunks" -name "*chunk*" -type f 2>/dev/null | wc -l)
    local knowledge_sources=$(find "$BASE_DIR/ai/datasets/raw_content" -type d 2>/dev/null | tail -n +2 | wc -l)
    echo -e "${BLUE}๐ง ุงููุนุฑูุฉ:${NC}"
    echo "  - ุงููุทุน ุงููุนุฑููุฉ: $knowledge_chunks"
    echo "  - ุงููุตุงุฏุฑ: $knowledge_sources"
    
    # ุงูุณุฌูุงุช
    local log_files=$(find "$LOGS_DIR" -name "*.log" -type f 2>/dev/null | wc -l)
    local log_size=$(du -sh "$LOGS_DIR" 2>/dev/null | cut -f1)
    echo -e "${BLUE}๐ ุงูุณุฌูุงุช:${NC}"
    echo "  - ุงููููุงุช: $log_files"
    echo "  - ุงูุญุฌู: $log_size"
    
    if [ "$detailed" = true ]; then
        echo ""
        echo -e "${YELLOW}๐ ุฅุญุตุงุฆูุงุช ููุตูุฉ:${NC}"
        
        # ูุฑุงุฑุงุช ุงููุฏูุฑ
        if [ -f "$LOGS_DIR/orchestrator/decisions.log" ]; then
            local decisions_count=$(wc -l < "$LOGS_DIR/orchestrator/decisions.log")
            echo "  - ูุฑุงุฑุงุช ุงููุฏูุฑ: $decisions_count"
        fi
        
        # ุฌูุฏุฉ ุงูุฑุฏูุฏ
        if [ -f "$LOGS_DIR/quality_feedback.csv" ]; then
            local feedback_count=$(wc -l < "$LOGS_DIR/quality_feedback.csv")
            echo "  - ุชููููุงุช ุงูุฌูุฏุฉ: $feedback_count"
        fi
    fi
    
    echo "=========================================="
}

# ุนุฑุถ ุงูุณุฌูุงุช
show_logs() {
    local log_type="$1"
    local follow=false
    
    # ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช
    while [[ $# -gt 0 ]]; do
        case $1 in
            --follow)
                follow=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [ -z "$log_type" ]; then
        echo -e "${CYAN}๐ ุงูุณุฌูุงุช ุงููุชุงุญุฉ:${NC}"
        find "$LOGS_DIR" -name "*.log" -type f | while read log_file; do
            local relative_path=${log_file#$LOGS_DIR/}
            local size=$(du -h "$log_file" | cut -f1)
            local lines=$(wc -l < "$log_file" 2>/dev/null || echo "0")
            echo "  ๐ $relative_path ($size, $lines ุณุทุฑ)"
        done
        return 0
    fi
    
    local log_file="$LOGS_DIR/${log_type}.log"
    if [ ! -f "$log_file" ]; then
        log_error "ุงูุณุฌู ุบูุฑ ููุฌูุฏ: $log_type"
        echo -e "${YELLOW}ุฌุฑุจ: $0 logs ูุนุฑุถ ุงูุณุฌูุงุช ุงููุชุงุญุฉ${NC}"
        return 1
    fi
    
    if [ "$follow" = true ]; then
        log_info "ูุชุงุจุนุฉ ุงูุณุฌู: $log_type"
        tail -f "$log_file"
    else
        echo -e "${CYAN}ุขุฎุฑ 20 ุณุทุฑ ูู $log_type:${NC}"
        tail -n 20 "$log_file"
    fi
}

# ูุงุฆูุฉ ุงูุนูุงู
list_agents() {
    echo -e "${CYAN}๐ฅ ุงูุนูุงู ุงููุชุงุญูู:${NC}"
    echo "=========================================="
    
    # ูู ูุฑุงุฑุงุช ุงููุฏูุฑ ุงููุณุฌูุฉ
    if [ -f "$LOGS_DIR/orchestrator/decisions.log" ]; then
        echo -e "${BLUE}๐ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุณุฌูุงุช:${NC}"
        for agent in "debug_expert" "system_architect" "technical_coach" "knowledge_spider"; do
            local count=$(grep -c "$agent" "$LOGS_DIR/orchestrator/decisions.log" 2>/dev/null || echo "0")
            echo "  - $agent: $count ูููุฉ"
        done
    fi
    
    echo ""
    echo -e "${YELLOW}๐ฏ ุฃููุงุน ุงูููุงู:${NC}"
    echo "  - ๐ debug_expert: ุงูุฃุฎุทุงุก ูุงูุชุตุญูุญ"
    echo "  - ๐๏ธ  system_architect: ุงูุชุตููู ูุงูููุฏุณุฉ"
    echo "  - ๐จโ๐ซ technical_coach: ุงูุชุฏุฑูุจ ูุงูุชุนูู"
    echo "  - ๐ธ๏ธ  knowledge_spider: ุฌูุน ุงููุนุฑูุฉ"
}

# ุฅุญุตุงุฆูุงุช ุงููุนุฑูุฉ
show_knowledge() {
    echo -e "${CYAN}๐ง ุฅุญุตุงุฆูุงุช ุงููุนุฑูุฉ:${NC}"
    echo "=========================================="
    
    local total_chunks=0
    local total_sources=0
    
    # ุงููุทุน ุงููุนุฑููุฉ
    if [ -d "$BASE_DIR/ai/datasets/knowledge_chunks" ]; then
        total_chunks=$(find "$BASE_DIR/ai/datasets/knowledge_chunks" -name "*chunk*" -type f | wc -l)
        echo -e "${BLUE}๐ ุงููุทุน ุงููุนุฑููุฉ:${NC}"
        echo "  - ุงูุฅุฌูุงูู: $total_chunks"
        
        # ุงูุชูุฒูุน ุญุณุจ ุงูููุน
        echo "  - ุงูุชูุฒูุน:"
        find "$BASE_DIR/ai/datasets/knowledge_chunks" -name "*chunk*" -type f | sed 's/.*_chunk_[0-9]*//' | sort | uniq -c | while read count type; do
            echo "    โข $count: ${type:-ุนุงู}"
        done
    fi
    
    # ุงููุตุงุฏุฑ
    if [ -d "$BASE_DIR/ai/datasets/raw_content" ]; then
        total_sources=$(find "$BASE_DIR/ai/datasets/raw_content" -type d | tail -n +2 | wc -l)
        echo -e "${BLUE}๐ ุงููุตุงุฏุฑ:${NC}"
        echo "  - ุงูุฅุฌูุงูู: $total_sources"
        
        # ุงููุตุงุฏุฑ ุงููุฑุฏูุฉ
        echo "  - ุงููุงุฆูุฉ:"
        find "$BASE_DIR/ai/datasets/raw_content" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | while read source; do
            local source_count=$(find "$BASE_DIR/ai/datasets/raw_content/$source" -name "*.html" -type f | wc -l)
            echo "    โข $source: $source_count ุตูุญุฉ"
        done
    fi
    
    # ุงูุฌูุฏุฉ
    if [ -f "$LOGS_DIR/spider/spider.log" ]; then
        echo -e "${BLUE}๐ ุงูุฌูุฏุฉ:${NC}"
        local last_quality=$(grep "ุฌูุฏุฉ ุงููุนุฑูุฉ:" "$LOGS_DIR/spider/spider.log" | tail -1)
        if [ -n "$last_quality" ]; then
            echo "  - ุขุฎุฑ ุชูููู: $last_quality"
        fi
    fi
}

# ุชูุธูู ุงูุณุฌูุงุช
clean_logs() {
    local days=7
    
    # ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช
    while [[ $# -gt 0 ]]; do
        case $1 in
            --days)
                days="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    log_info "ุชูุธูู ุงูุณุฌูุงุช ุงูุฃูุฏู ูู $days ุฃูุงู..."
    
    local deleted_count=0
    find "$LOGS_DIR" -name "*.log" -type f -mtime "+$days" | while read old_log; do
        log_debug "ุญุฐู: $old_log"
        rm -f "$old_log"
        ((deleted_count++))
    done
    
    log_success "ุชู ุญุฐู $deleted_count ููู ุณุฌู ูุฏูู"
}

# ุงูุชูููุฐ ุงูุฑุฆูุณู
main() {
    check_factory_exists
    
    case "${1:-}" in
        init)
            init_factory
            ;;
        start)
            start_app "$2"
            ;;
        stop)
            stop_app "$2"
            ;;
        decide)
            decide_agent "$2" "$3"
            ;;
        spider)
            shift
            run_spider "$@"
            ;;
        status)
            shift
            show_status "$@"
            ;;
        logs)
            shift
            show_logs "$@"
            ;;
        agents)
            list_agents
            ;;
        knowledge)
            show_knowledge
            ;;
        clean)
            shift
            clean_logs "$@"
            ;;
        *)
            usage
            ;;
    esac
}

main "$@"

# ุฃูุฑ ูุนุงูุฌุฉ PDF
pdf_ingest()
    log_info "ูุนุงูุฌุฉ ูููุงุช PDF..."
    
    PDF_SCRIPT="$BASE_DIR/scripts/ai/pdf_processor/pdf_ingest.sh"
    
    if [ ! -f "$PDF_SCRIPT" ]; then
        log_error "ูุนุงูุฌ PDF ุบูุฑ ููุฌูุฏ: $PDF_SCRIPT"
        return 1
    fi
    
    # ุชุดุบูู ูุนุงูุฌ PDF
    "$PDF_SCRIPT"
}
